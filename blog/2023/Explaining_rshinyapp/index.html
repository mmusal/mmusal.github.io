<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Building an rshiny SMR map | Rasim Muzaffer Musal</title> <meta name="author" content="Rasim Muzaffer Musal"> <meta name="description" content="This blog exists to explain the research ideas I have and tutorials for particular subjects. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="Applied Bayesian Models, Hidden Markov Models, Spatial Models"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://mmusal.github.io/blog/2023/Explaining_rshinyapp/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Rasim </span>Muzaffer Musal</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">Me</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">App. Bayesian Stats. and rest<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">Resume</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Building an rshiny SMR map</h1> <p class="post-meta">October 7, 2023• Rasim M Musal</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/rshiny"> <i class="fas fa-hashtag fa-sm"></i> rshiny</a>   <a href="/blog/tag/maps"> <i class="fas fa-hashtag fa-sm"></i> maps</a>   <a href="/blog/tag/smr"> <i class="fas fa-hashtag fa-sm"></i> SMR</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> ```{r setup, include=FALSE} knitr::opts_chunk$set(echo = TRUE,fig.path = ('./assets/img/2023-10-04-Intro_to_Spatial_Tools_and_Files')) ``` # Discussing Rshiny R allows you to use the rshiny package in order to build web applications. An excellent introduction to building rshiny apps are given by [Posit](https://shiny.posit.co/r/articles/start/build/) and [Bookdown](https://bookdown.org/hadrien/how_to_build_a_shiny_app_from_scratch/). Here we assume the reader has working knowledge of rshiny and present the code that my graduate student Anjali Goel have presented in 2022. The application is a map of California that shows how the standardized mortality ratios (SMR) of Covid-19 mortality change over 77 biweeks. The application is at [shiny server](https://mmusal.shinyapps.io/timeseriesofSMR/). # Application code ```{r, eval = FALSE} knitr::opts_chunk$set(eval = FALSE) library(shiny) library(rgdal) library(DT) library(dygraphs) library(xts) library(leaflet) library(shinyjs) #It is important to comment out the lines starting with wd and setwd after running otherwise the app will not deploy. #wd='C:/Users/rm84/Documents/timeseriesofSMR' #setwd(wd) data &lt;- as.data.frame(read.csv("./data/SMR.csv")) names(data)[names(data) == "County"] &lt;- "county" ##Reading shape file map &lt;- readOGR("./map/tl_2021_us_county.shp") #Filtering to include only counties in CA. map=map[(map$STATEFP %in% '06'),] # ui object ui &lt;- fluidPage( useShinyjs(), titlePanel(p("Spatial app", style = "color:#3474A7")), actionButton(inputId = "button", label = "Show/Hide Panel"), sidebarLayout( div(id = "sidebar", sidebarPanel( selectInput( inputId = "variableselected", label = "Select variable", choices = c("SMR") ), sliderInput("periods", "Periods (1 - 77):", min = 1, max = 77, value = 1, step = 1, animate = animationOptions(interval = 1000, loop = FALSE) ), )), mainPanel( leafletOutput(outputId = "map", width = "100%", height = 800) ) ) ) # server() server &lt;- function(input, output) { shinyjs::hide(id = "variableselected") ## observe the button being pressed observeEvent(input$button, { if(input$button %% 2 == 1){ shinyjs::hide(id = "sidebar") }else{ shinyjs::show(id = "sidebar") } }) output$map &lt;- renderLeaflet({ # Add data to map datafiltered &lt;- data[which(data$Time == input$periods), ] ordercounties &lt;- match(map@data$NAME, datafiltered$county) map@data &lt;- datafiltered[ordercounties, ] # Create variableplot # ADD this to create variableplot map$variableplot &lt;- as.numeric( map@data[, input$variableselected]) # Create leaflet # CHANGE map$cases by map$variableplot pal &lt;- colorBin("Reds", domain = map$variableplot , bins = c(0,1,2,3,4,5,6,7,51) ) # CHANGE map$cases by map$variableplot labels &lt;- sprintf("%s: %g", map$county, map$variableplot) %&gt;% lapply(htmltools::HTML) # CHANGE cases by variableplot l &lt;- leaflet(map) %&gt;% addTiles() %&gt;% addPolygons( fillColor = ~ pal(variableplot), color = "white", dashArray = "3", fillOpacity = 0.4, label = labels ) %&gt;% # CHANGE cases by variableplot leaflet::addLegend( pal = pal, values = ~variableplot, opacity = 0.7, title = NULL ) }) } # shinyApp() shinyApp(ui = ui, server = server) ``` # Discussing the calculation for SMR The application itself resides in the [shiny server](https://mmusal.shinyapps.io/timeseriesofSMR/) and shows 77 biweeks (t=1,...T=77) of Covid-19 Standardized Mortality Ratio (SMR) in the 58 counties of California. The SMR in this application is calculated for a given time period "t". Below $Pop_{i}$ is population of county "i". We used the 2020 and 2021 population (there will be more explanation when I document the data work). $\omega$ represents the population weight of county "i" among N (58) counties in California. \[\omega_{i}=\frac{Pop_{i}}{\sum_{i}^{N}Pop_{i}}\] In other applications expected mortality at time period $t$, county $i$, is adjusted by age/sex but we prefer to use these solely as model variables and therefore $E_{t,i}$ is, \[E_{t,i}=(\sum_{i}y_{t,i})*\omega_{i}\] Therefore you can think about $E_{t,i}$ as the expected number of people who would die of Covid-19 if mortality risk was uniformly distributed across the population (death from Covid-19 was equally likely). In conclusion SMR is calculated as \[SMR_{t,i}=\frac{y_{t,i}}{E_{t,i}}\] # Noting issues on SMR values There are a few things to note about SMR among these 58 counties across 77 biweeks. 0. One of the first things people note is that we are not using SIR models where population changes at every time period with deaths and births. The main reason we are not using SIR models is that we do not have such data directly available. On the other hand since we are working with ratios the main assumption we make is that the county population ratios $\omega$ do not change. 1. Each SMR value is calculated based on the total observed deaths in a biweek. Especially in the first set of biweeks most of the counties have no recorded deaths. This means a single death occurring in a county with an $E_{t,i}$ of 0.05 lead to an $SMR_{t,i}$ of 20. Drawing inferences based on a few biweeks of data would be an example of [the law of small numbers](https://en.wikipedia.org/wiki/Law_of_small_numbers). We can not draw healthy inferences on what affects SMR (our main goal) based on few weeks of data. 2. Connected to 1, we have to remember smaller counties will have higher variances. 3. 1 and 2 will require us to come up with some sort of smoothing mechanism if we are to draw inferences of how various variables effect SMR. 4. When we create visualizations we need to be aware as to what we show. Every biweek SMR is calculated independent of the previous biweeks. A county that does not perform well will create higher E values therefore reducing the SMR for the other counties. We could develop a cumulative SMR value that can be in another post. </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Rasim Muzaffer Musal. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: October 08, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>