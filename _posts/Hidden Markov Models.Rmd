---
layout: post
title: "Hidden Markov Models"
author: "Rasim M Musal"
date: "2023-10-10"
output:
  html_document:
   theme: darkly
   highlight: espresso
   toc: true
   keep_md: yes
   toc_float: true
   toc_collapsed: true
   toc_depth: 3
   number_sections: true
tags: [rshiny, maps,SMR]
always_allow_html: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.path = ('./assets/img/2023-10-07-Hidden_Markov_Models'))
```
A good introduction to Hidden Markov Models is [illustrated](https://nipunbatra.github.io/hmm/). In this post we will explain the application of the model we are developing using notation that will be consistent across the project.
We would like to make inferences about effects on $Y_{ti}$, the number of Covid-19 mortality recorded at time $t$ in county $i$. The time index $t$ is between $(t=0 \ldots (T-1)=76)$. There are 58 counties in California $(i=1, \ldots ,58)$ For the moment we will ignore covariates and focus on "regime" $k$ that define the characteristics of the uncertainty that defines the uncertainty of $Y_{ti}$.

Assume $i=1$
In order to make inferences via our HMM model we would need to obtain the joint probability density of mortality and regimes at every $t$.   
\[P(Y_{1:T},k_{1:T})\]
To obtain this joint probability we will need to make assumptions.
1) A regime determines the parameters of the uncertainty distribution.
2) Given the parameters the regime does not provide additional information about $Y_{t}$.  
\[P(Y_{t}|\lambda_{tk})=P(Y_{t}|\lambda_{tk},k_{t})=P(Y_{t}|k_{t})\]
3) For the purposes of this post we will assume that at time $t$ the distribution of Covid-19 mortality follows a Poisson distribution.
\[P(Y_{t}|\lambda_{tk},k_{t})=Poisson(Y_{t}|\lambda_{tk})\]

If we did not have different regimes across a time component we could have used mixture models due to their [close relationship](https://www.utstat.toronto.edu/~rsalakhu/sta4273/notes/Lecture11.pdf) with hidden markov models. Assuming we had a mixture of 2 Poisson distributions (K=2) we could write the mixture distribution of Covid-19 mortality at time period $t$ county $i$ as 

\[P(Y_{ti}) \sim \omega_{k=1}*Pois.(\lambda_{t1i})+\omega_{k=2}*Pois.(\lambda_{t2i}) \]

This setup assumes that $Y_{ti}$ is independent and identically distributed both across $t$ and $i$. If we wrote the likelihood for this model it would look like
\[P(Y_{0,1},Y_{0,2},\ldots Y_{0,N},Y_{1,1} \ldots Y_{T-1,N}|\lambda_{0,1}\ldots\lambda_{T-1,N},\omega_{1},\omega_{2})\]
\[\Pi_{i=1}^{i=N}\Pi_{t=0}^{t=T-1}  (\omega_{m=1}*Pois.(\lambda_{t1i})+\omega_{m=2}*Pois.(\lambda_{t2i})),\]

where $\lambda_{tki}$ represents the mean/variance of Covid-19 mortality at time $t$, regime k, county i.

We would like to relax this assumption about $t$ and instead make the claim that the previous observations inform us as to $Y_{t}$ and build Hidden Markov Models (HMM).

In formulating the HMM we again assume K=2, however we will assume an order 1 Markov model (markov property). Below, k_{t} is 1 or 2.
\[P(k_{t}|k_{t-1})=P(k_{t}|k_{t-1},\ldots,k_{0}).\]
In an order 1 Markov model the only thing that matters to inform the uncertainty of $k_{t}$ is at  $t-1$.
In addition 
$P(Y_{tki}|k_{t})=P(Y_{tki}|k_{t},Y_{(t-1),k,i},\ldots Y_{0,k,i} )$

The matrix created from the probabilities between the states is called the transition matrix. The format of the matrix ensures that it is a stochastic matrix such that the rows sum to 1. 
                                                  

| From/To |    $k_{t}=1$ |    $k_{t}=2$ | 
|:-------:|:------:|:-----------:|
| $k_{t-1}=1$ | $\pi_{11}$ | 1-$\pi_{11}$ |
| $k_{t-1}=2$ | $\pi_{21}$ | 1-$\pi_{21}$ |



                                             







